<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—å†…å•†å“æ¤œç´¢ã‚¢ãƒ—ãƒª (Firebaseç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #main-container {
            display: flex;
            gap: 20px;
        }

        #left-panel {
            flex: 1;
            transition: width 0.3s ease-in-out;
        }

        #right-panel {
            width: 300px;
            border: 2px solid #17a2b8;
            background-color: #f0f8ff;
            padding: 15px;
            overflow: hidden;
            white-space: nowrap;
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out;
        }

        #right-panel.hidden {
            width: 0;
            padding: 0;
            border-width: 0;
        }

        #panel-toggle-btn {
            padding: 5px 10px;
            cursor: pointer;
        }

        #panel-content.hidden {
            display: none;
        }

        #search-area,
        #mode-switcher {
            margin-bottom: 15px;
        }

        #search-input,
        .product-input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 80%;
        }

        #search-button,
        .add-btn {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #export-csv-btn {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        #map-wrapper {
            border: 2px solid #ccc;
            padding: 10px;
            height: 600px;
            overflow: hidden;
            touch-action: none;
        }

        #map-wrapper svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #mode-switcher label {
            font-weight: bold;
            user-select: none;
        }

        .selected {
            fill: #1E90FF !important;
            stroke: #0056b3 !important;
            stroke-width: 2px !important;
        }

        .multi-selected {
            fill: #FFA500 !important;
            stroke: #A06800 !important;
            stroke-width: 2px !important;
        }

        .highlight-search {
            fill: red !important;
            animation: blink-animation 1.2s infinite;
        }

        @keyframes blink-animation {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .gaming-mode {
            animation: rainbow-animation 3s infinite;
        }

        @keyframes rainbow-animation {

            0%,
            100% {
                fill: red;
            }

            16% {
                fill: orange;
            }

            33% {
                fill: yellow;
            }

            50% {
                fill: lime;
            }

            66% {
                fill: cyan;
            }

            83% {
                fill: blue;
            }
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>åº—å†…å•†å“æ¤œç´¢ã‚¢ãƒ—ãƒª (Firebaseç‰ˆ)</h1>
        <div id="panel-toggle-area">
            <button id="panel-toggle-btn">ãƒ‘ãƒãƒ«ã‚’é–‹ã</button>
        </div>
    </div>
    <div id="main-container">
        <div id="left-panel">
            <div id="search-area">
                <input type="text" id="search-input" placeholder="å•†å“åã‚’å…¥åŠ›">
                <button id="search-button">æ¤œç´¢</button>
            </div>
            <div id="mode-switcher">
                <label><input type="checkbox" id="multi-select-mode"> è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰</label>
            </div>
            <div id="map-wrapper"></div>
        </div>
        <div id="right-panel" class="hidden">
            <div id="panel-content" class="hidden">
                <h2>å•†å“ç™»éŒ²ãƒ‘ãƒãƒ«</h2>
                <div id="info-area">
                    <p>ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...</p>
                </div>
                <button id="export-csv-btn">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2RWsPZwb9ZukbF8ijP9A_F3czf_q05-0",
            authDomain: "map-app-1b118.firebaseapp.com",
            projectId: "map-app-1b118",
            storageBucket: "map-app-1b118.firebasestorage.app",
            messagingSenderId: "875757738307",
            appId: "1:875757738307:web:00865ef8281907b8e037f6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const svgFileName = 'AllStoreMap.svg';
        let svg = null;
        let productLocationDatabase = {};
        const shelfMasterData = {
            'dry': { displayName: 'é£²æ–™,ãŠè“å­,èª¿å‘³æ–™' }, 'delica': { displayName: 'ãŠæƒ£èœ' }, 'veg': { displayName: 'é‡èœ' },
            'dailyWa': { displayName: 'æ—¥é…å“(å’Œ)' }, 'daylyEu': { displayName: 'æ—¥é…å“(æ´‹)' }, 'meat': { displayName: 'ãŠè‚‰' },
            'fish': { displayName: 'ãŠé­š' }, 'med': { displayName: 'è–¬å“' }, 'bread': { displayName: 'ãƒ‘ãƒ³' },
            'froz': { displayName: 'å†·å‡é£Ÿå“' }, 'combat': { displayName: 'æ®ºè™«å‰¤ãƒ»æ—¥ç”¨å“' }, 'garden': { displayName: 'åœ’èŠ¸ç”¨å“' }, 'book': { displayName: 'æ›¸ç±' }
        };
        const shelfPrefixes = Object.keys(shelfMasterData);
        const shelfSelector = shelfPrefixes.map(p => `[id^="${p}_"]`).join(', ');
        let appState = {
            shelvesData: new Map(), selectedShelfId: null, searchedShelfId: null,
            isGamingMode: false, isMultiSelectMode: false, multiSelectedShelves: new Set()
        };

        const log = (message) => { document.getElementById('info-area').innerHTML = `<p>${message}</p>`; };

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            document.getElementById('export-csv-btn').addEventListener('click', exportAllDataToCsv);
            document.getElementById('multi-select-mode').addEventListener('change', (e) => {
                appState.isMultiSelectMode = e.target.checked; appState.selectedShelfId = null;
                appState.multiSelectedShelves.clear(); redrawMapColors(); updateInfoPanel();
            });
            // â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜… ãƒœã‚¿ãƒ³ã®å ´æ‰€ãŒå¤‰ã‚ã£ã¦ã‚‚ã€æ©Ÿèƒ½ã¯åŒã˜
            document.getElementById('panel-toggle-btn').addEventListener('click', togglePanel);
        });

        function togglePanel() {
            const rightPanel = document.getElementById('right-panel');
            const panelContent = document.getElementById('panel-content');
            const toggleBtn = document.getElementById('panel-toggle-btn');
            rightPanel.classList.toggle('hidden');
            // å°‘ã—é…ã‚Œã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤ºã«ã™ã‚‹ã“ã¨ã§ã€ãªã‚ã‚‰ã‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«è¦‹ã›ã‚‹
            if (rightPanel.classList.contains('hidden')) {
                panelContent.classList.add('hidden');
                toggleBtn.textContent = 'ãƒ‘ãƒãƒ«ã‚’é–‹ã';
            } else {
                setTimeout(() => {
                    panelContent.classList.remove('hidden');
                }, 150); // 0.15ç§’å¾Œ
                toggleBtn.textContent = 'ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹';
            }
        }

        async function initializeApp() {
            try {
                await auth.signInAnonymously();
                const mapWrapper = document.getElementById('map-wrapper');
                const response = await fetch(svgFileName);
                if (!response.ok) throw new Error(`ãƒãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«(${svgFileName})ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                mapWrapper.innerHTML = await response.text();
                svg = mapWrapper.querySelector('svg');
                if (!svg) throw new Error('SVGã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');

             const panzoom = Panzoom(svg, { maxScale: 10, minScale: 0.5, contain: 'outside' });
                mapWrapper.addEventListener('wheel', panzoom.zoomWithWheel);

                setupRealtimeListeners();
                setupMapClickListener();

                document.getElementById('search-button').addEventListener('click', performSearch);
                document.getElementById('search-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
            } catch (error) { log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`); }
        }

        function setupRealtimeListeners() {
            db.collection('shelves').onSnapshot(snapshot => {
                productLocationDatabase = {};
                snapshot.forEach(doc => {
                    appState.shelvesData.set(doc.id, doc.data());
                    const data = doc.data();
                    if (data.products && Array.isArray(data.products)) {
                        data.products.forEach(productName => { productLocationDatabase[productName] = doc.id; });
                    }
                });
                redrawMapColors();
                log('æº–å‚™å®Œäº†ï¼');
            });
        }

        function redrawMapColors() {
            if (!svg) return;
            const allShelves = svg.querySelectorAll(shelfSelector);
            allShelves.forEach(shelf => {
                const shelfId = shelf.id;
                const shelfData = appState.shelvesData.get(shelfId) || {};
                const isCompleted = shelfData.completed === true;
                shelf.classList.remove('highlight-search', 'gaming-mode', 'selected', 'multi-selected');
                shelf.style.stroke = 'black'; shelf.style.strokeWidth = '0.5px';
                if (appState.isGamingMode) {
                    shelf.style.removeProperty('fill'); shelf.classList.add('gaming-mode');
                } else if (shelfId === appState.searchedShelfId) {
                    shelf.style.setProperty('fill', 'red', 'important'); shelf.classList.add('highlight-search');
                } else if (appState.isMultiSelectMode && appState.multiSelectedShelves.has(shelfId)) {
                    shelf.classList.add('multi-selected');
                } else if (shelfId === appState.selectedShelfId) {
                    shelf.classList.add('selected');
                } else if (isCompleted) {
                    shelf.style.setProperty('fill', '#BDE0FE', 'important');
                } else {
                    shelf.style.setProperty('fill', '#FFFACD', 'important');
                }
            });
        }

        function setupMapClickListener() {
            if (!svg) return;
            svg.addEventListener('click', (event) => {
                const clickedElement = event.target;
                let shelfId = findShelfId(clickedElement);
                if (shelfId) {
                    if (appState.isMultiSelectMode) { handleMultiSelectClick(shelfId); }
                    else { handleSingleSelectClick(shelfId); }
                }
            });
        }

        function findShelfId(element) {
            let current = element;
            while (current && current !== svg) {
                const id = current.id;
                if (id && shelfPrefixes.some(prefix => id.startsWith(prefix + '_'))) { return id; }
                current = current.parentElement;
            }
            return null;
        }

        function handleSingleSelectClick(shelfId) {
            appState.selectedShelfId = (appState.selectedShelfId === shelfId) ? null : shelfId;
            appState.searchedShelfId = null; appState.isGamingMode = false;
            redrawMapColors(); updateInfoPanel();
        }

        function handleMultiSelectClick(shelfId) {
            if (appState.multiSelectedShelves.has(shelfId)) { appState.multiSelectedShelves.delete(shelfId); }
            else { appState.multiSelectedShelves.add(shelfId); }
            redrawMapColors(); updateInfoPanel();
        }

        function performSearch() {
            appState.selectedShelfId = null; appState.multiSelectedShelves.clear();
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) { redrawMapColors(); return; }
            if (searchTerm === 'ã‚²ãƒ¼ãƒŸãƒ³ã‚°æ£š' || searchTerm === 'gamingshelf') {
                appState.isGamingMode = true; appState.searchedShelfId = null; log('âœ¨ğŸ‰ ã‚²ãƒ¼ãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•ï¼ ğŸ‰âœ¨');
            } else {
                appState.isGamingMode = false;
                const shelfId = productLocationDatabase[searchTerm];
                if (shelfId) {
                    appState.searchedShelfId = shelfId;
                    const displayName = shelfMasterData[shelfId.split('_')[0]].displayName;
                    const shelfNumber = shelfId.split('_')[1];
                    log(`ã€Œ${searchTerm}ã€ï¼ˆ${displayName} ${shelfNumber}ç•ªï¼‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¾ã™ã€‚`);
                } else {
                    appState.searchedShelfId = null; log(`ã€Œ${searchTerm}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                }
            }
            redrawMapColors(); searchInput.value = '';
        }

        function updateInfoPanel() {
            if (appState.isMultiSelectMode) { updateInfoPanelForMultiSelect(); }
            else if (appState.selectedShelfId) { updateInfoPanelForSingleSelect(appState.selectedShelfId); }
            else { document.getElementById('info-area').innerHTML = `<p>æ£šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å•†å“ã‚’ç·¨é›†ãƒ»ç¢ºèªã§ãã¾ã™ã€‚</p>`; }
        }

        function updateInfoPanelForSingleSelect(shelfId) {
            const infoArea = document.getElementById('info-area');
            const parts = shelfId.split('_');
            const prefix = parts[0];
            const shelfNumber = parts[1];
            const displayName = shelfMasterData[prefix] ? shelfMasterData[prefix].displayName : prefix;
            infoArea.innerHTML = `<h3>${displayName} ${shelfNumber}ç•ª</h3><div id="status-area"></div><ul id="product-list"></ul><div><input type="text" class="product-input" id="new-product-input" placeholder="ã‚Šã‚“ã”ã€ã°ãªãª..."><button class="add-btn" id="add-product-btn">è¿½åŠ </button></div>`;
            document.getElementById('add-product-btn').onclick = () => {
                const input = document.getElementById('new-product-input');
                if (input.value) { addProductsToShelves([shelfId], input.value); input.value = ''; }
            };
            db.collection('shelves').doc(shelfId).onSnapshot(doc => {
                const productList = document.getElementById('product-list');
                const statusArea = document.getElementById('status-area');
                if (!productList || !statusArea) return;
                const shelfData = doc.exists ? doc.data() : {};
                const isCompleted = shelfData.completed === true;
                statusArea.innerHTML = isCompleted ? `<p id="shelf-status">ã“ã®æ£šã¯ç™»éŒ²æ¸ˆã¿ã§ã™</p><button id="toggle-status-btn">æœªç™»éŒ²ã«æˆ»ã™</button>` : `<p>ã“ã®æ£šã¯ã¾ã æœªç™»éŒ²ã§ã™</p><button id="toggle-status-btn">ç™»éŒ²æ¸ˆã¿ã«ã™ã‚‹</button>`;
                document.getElementById('toggle-status-btn').onclick = () => toggleShelfStatus(shelfId, !isCompleted);
                productList.innerHTML = '';
                if (shelfData.products && shelfData.products.length > 0) {
                    shelfData.products.forEach(productName => {
                        const li = document.createElement('li');
                        li.textContent = productName;
                        const deleteBtn = document.createElement('span');
                        deleteBtn.textContent = ' âœ–'; deleteBtn.className = 'delete-btn';
                        deleteBtn.onclick = () => deleteProduct(shelfId, productName);
                        li.appendChild(deleteBtn); productList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'ï¼ˆã¾ã å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰'; productList.appendChild(li);
                }
            });
        }

        function updateInfoPanelForMultiSelect() {
            const infoArea = document.getElementById('info-area');
            const selectedCount = appState.multiSelectedShelves.size;
            let selectedShelvesHtml = '';
            appState.multiSelectedShelves.forEach(shelfId => {
                const parts = shelfId.split('_');
                const displayName = shelfMasterData[parts[0]] ? shelfMasterData[parts[0]].displayName : parts[0];
                selectedShelvesHtml += `<li>${displayName} ${parts[1]}ç•ª</li>`;
            });
            infoArea.innerHTML = `<h3>è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰</h3><p>${selectedCount}å€‹ã®æ£šã‚’é¸æŠä¸­</p><ul>${selectedShelvesHtml}</ul><div><input type="text" class="product-input" id="new-products-input" placeholder="ã‚Šã‚“ã”ã€ã°ãªãª..."><button class="add-btn" id="add-products-btn">é¸æŠä¸­ã®æ£šã«è¿½åŠ </button></div>`;
            document.getElementById('add-products-btn').onclick = () => {
                const input = document.getElementById('new-products-input');
                if (input.value) { addProductsToShelves(Array.from(appState.multiSelectedShelves), input.value); input.value = ''; }
            };
        }

        function addProductsToShelves(shelfIds, productsString) {
            const normalizedString = productsString.replace(/ã€/g, ',');
            const productNames = normalizedString.split(',').map(name => name.trim()).filter(name => name);
            if (productNames.length === 0 || shelfIds.length === 0) return;
            shelfIds.forEach(shelfId => {
                db.collection('shelves').doc(shelfId).set({
                    products: firebase.firestore.FieldValue.arrayUnion(...productNames)
                }, { merge: true });
            });
        }

        function deleteProduct(shelfId, productName) {
            db.collection('shelves').doc(shelfId).update({ products: firebase.firestore.FieldValue.arrayRemove(productName) });
        }
        function toggleShelfStatus(shelfId, newStatus) {
            db.collection('shelves').doc(shelfId).set({ completed: newStatus }, { merge: true });
        }
        async function exportAllDataToCsv() {
            log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™...');
            try {
                const snapshot = await db.collection('shelves').get();
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "å•†å“å,æ£šID,æ£šã®æ­£å¼åç§°,ç™»éŒ²å®Œäº†\r\n";
                snapshot.forEach(doc => {
                    const shelfId = doc.id;
                    const data = doc.data();
                    const prefix = shelfId.split('_')[0];
                    const displayName = shelfMasterData[prefix] ? shelfMasterData[prefix].displayName : prefix;
                    const isCompleted = data.completed ? 'ã¯ã„' : 'ã„ã„ãˆ';
                    if (data.products && Array.isArray(data.products)) {
                        data.products.forEach(productName => {
                            csvContent += `"${productName}","${shelfId}","${displayName}","${isCompleted}"\r\n`;
                        });
                    }
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "products_backup.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('å…¨ãƒ‡ãƒ¼ã‚¿ã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            } catch (error) { console.error("CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:", error); log('CSVã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'); }
        }
    </script>
</body>

</html>