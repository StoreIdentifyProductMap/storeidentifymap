<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店内商品検索アプリ (Firebase版)</title>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #main-container {
            display: flex;
            gap: 20px;
        }

        #left-panel {
            flex: 1;
            transition: width 0.3s ease-in-out;
        }

        #right-panel {
            width: 300px;
            border: 2px solid #17a2b8;
            background-color: #f0f8ff;
            padding: 15px;
            overflow: hidden;
            white-space: nowrap;
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out;
        }

        #right-panel.hidden {
            width: 0;
            padding: 0;
            border-width: 0;
        }

        #panel-toggle-btn {
            padding: 5px 10px;
            cursor: pointer;
        }

        #panel-content.hidden {
            display: none;
        }

        #search-area,
        #mode-switcher {
            margin-bottom: 15px;
        }

        #search-input,
        .product-input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 80%;
        }

        #search-button,
        .add-btn {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #export-csv-btn {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        #map-wrapper {
            border: 2px solid #ccc;
            padding: 10px;
            height: 600px;
            overflow: hidden;
            touch-action: none;
        }

        #map-wrapper svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #mode-switcher label {
            font-weight: bold;
            user-select: none;
        }

        .selected {
            fill: #1E90FF !important;
            stroke: #0056b3 !important;
            stroke-width: 2px !important;
        }

        .multi-selected {
            fill: #FFA500 !important;
            stroke: #A06800 !important;
            stroke-width: 2px !important;
        }

        .highlight-search {
            fill: red !important;
            animation: blink-animation 1.2s infinite;
        }

        @keyframes blink-animation {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .gaming-mode {
            animation: rainbow-animation 3s infinite;
        }

        @keyframes rainbow-animation {

            0%,
            100% {
                fill: red;
            }

            16% {
                fill: orange;
            }

            33% {
                fill: yellow;
            }

            50% {
                fill: lime;
            }

            66% {
                fill: cyan;
            }

            83% {
                fill: blue;
            }
        }
    </style>
</head>

<body>
    <div id="header">
        <h1>店内商品検索アプリ (Firebase版)</h1>
        <div id="panel-toggle-area">
            <button id="panel-toggle-btn">パネルを開く</button>
        </div>
    </div>
    <div id="main-container">
        <div id="left-panel">
            <div id="search-area">
                <input type="text" id="search-input" placeholder="商品名を入力">
                <button id="search-button">検索</button>
            </div>
            <div id="mode-switcher">
                <label><input type="checkbox" id="multi-select-mode"> 複数選択モード</label>
            </div>
            <div id="map-wrapper"></div>
        </div>
        <div id="right-panel" class="hidden">
            <div id="panel-content" class="hidden">
                <h2>商品登録パネル</h2>
                <div id="info-area">
                    <p>アプリを起動しています...</p>
                </div>
                <button id="export-csv-btn">全データをCSVで保存</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2RWsPZwb9ZukbF8ijP9A_F3czf_q05-0",
            authDomain: "map-app-1b118.firebaseapp.com",
            projectId: "map-app-1b118",
            storageBucket: "map-app-1b118.firebasestorage.app",
            messagingSenderId: "875757738307",
            appId: "1:875757738307:web:00865ef8281907b8e037f6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const svgFileName = 'AllStoreMap.svg';
        let svg = null;
        let productLocationDatabase = {};
        const shelfMasterData = {
            'dry': { displayName: '飲料,お菓子,調味料' }, 'delica': { displayName: 'お惣菜' }, 'veg': { displayName: '野菜' },
            'dailyWa': { displayName: '日配品(和)' }, 'daylyEu': { displayName: '日配品(洋)' }, 'meat': { displayName: 'お肉' },
            'fish': { displayName: 'お魚' }, 'med': { displayName: '薬品' }, 'bread': { displayName: 'パン' },
            'froz': { displayName: '冷凍食品' }, 'combat': { displayName: '殺虫剤・日用品' }, 'garden': { displayName: '園芸用品' }, 'book': { displayName: '書籍' }
        };
        const shelfPrefixes = Object.keys(shelfMasterData);
        const shelfSelector = shelfPrefixes.map(p => `[id^="${p}_"]`).join(', ');
        let appState = {
            shelvesData: new Map(), selectedShelfId: null, searchedShelfId: null,
            isGamingMode: false, isMultiSelectMode: false, multiSelectedShelves: new Set()
        };

        const log = (message) => { document.getElementById('info-area').innerHTML = `<p>${message}</p>`; };

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
            document.getElementById('export-csv-btn').addEventListener('click', exportAllDataToCsv);
            document.getElementById('multi-select-mode').addEventListener('change', (e) => {
                appState.isMultiSelectMode = e.target.checked; appState.selectedShelfId = null;
                appState.multiSelectedShelves.clear(); redrawMapColors(); updateInfoPanel();
            });
            // ★★★ 修正点 ★★★ ボタンの場所が変わっても、機能は同じ
            document.getElementById('panel-toggle-btn').addEventListener('click', togglePanel);
        });

        function togglePanel() {
            const rightPanel = document.getElementById('right-panel');
            const panelContent = document.getElementById('panel-content');
            const toggleBtn = document.getElementById('panel-toggle-btn');
            rightPanel.classList.toggle('hidden');
            // 少し遅れてコンテンツを表示・非表示にすることで、なめらかなアニメーションに見せる
            if (rightPanel.classList.contains('hidden')) {
                panelContent.classList.add('hidden');
                toggleBtn.textContent = 'パネルを開く';
            } else {
                setTimeout(() => {
                    panelContent.classList.remove('hidden');
                }, 150); // 0.15秒後
                toggleBtn.textContent = 'パネルを閉じる';
            }
        }

        async function initializeApp() {
            try {
                await auth.signInAnonymously();
                const mapWrapper = document.getElementById('map-wrapper');
                const response = await fetch(svgFileName);
                if (!response.ok) throw new Error(`マップファイル(${svgFileName})が見つかりません。`);
                mapWrapper.innerHTML = await response.text();
                svg = mapWrapper.querySelector('svg');
                if (!svg) throw new Error('SVGタグが見つかりませんでした。');

             const panzoom = Panzoom(svg, { maxScale: 10, minScale: 0.5, contain: 'outside' });
                mapWrapper.addEventListener('wheel', panzoom.zoomWithWheel);

                setupRealtimeListeners();
                setupMapClickListener();

                document.getElementById('search-button').addEventListener('click', performSearch);
                document.getElementById('search-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
            } catch (error) { log(`初期化エラー: ${error.message}`); }
        }

        function setupRealtimeListeners() {
            db.collection('shelves').onSnapshot(snapshot => {
                productLocationDatabase = {};
                snapshot.forEach(doc => {
                    appState.shelvesData.set(doc.id, doc.data());
                    const data = doc.data();
                    if (data.products && Array.isArray(data.products)) {
                        data.products.forEach(productName => { productLocationDatabase[productName] = doc.id; });
                    }
                });
                redrawMapColors();
                log('準備完了！');
            });
        }

        function redrawMapColors() {
            if (!svg) return;
            const allShelves = svg.querySelectorAll(shelfSelector);
            allShelves.forEach(shelf => {
                const shelfId = shelf.id;
                const shelfData = appState.shelvesData.get(shelfId) || {};
                const isCompleted = shelfData.completed === true;
                shelf.classList.remove('highlight-search', 'gaming-mode', 'selected', 'multi-selected');
                shelf.style.stroke = 'black'; shelf.style.strokeWidth = '0.5px';
                if (appState.isGamingMode) {
                    shelf.style.removeProperty('fill'); shelf.classList.add('gaming-mode');
                } else if (shelfId === appState.searchedShelfId) {
                    shelf.style.setProperty('fill', 'red', 'important'); shelf.classList.add('highlight-search');
                } else if (appState.isMultiSelectMode && appState.multiSelectedShelves.has(shelfId)) {
                    shelf.classList.add('multi-selected');
                } else if (shelfId === appState.selectedShelfId) {
                    shelf.classList.add('selected');
                } else if (isCompleted) {
                    shelf.style.setProperty('fill', '#BDE0FE', 'important');
                } else {
                    shelf.style.setProperty('fill', '#FFFACD', 'important');
                }
            });
        }

        function setupMapClickListener() {
            if (!svg) return;
            svg.addEventListener('click', (event) => {
                const clickedElement = event.target;
                let shelfId = findShelfId(clickedElement);
                if (shelfId) {
                    if (appState.isMultiSelectMode) { handleMultiSelectClick(shelfId); }
                    else { handleSingleSelectClick(shelfId); }
                }
            });
        }

        function findShelfId(element) {
            let current = element;
            while (current && current !== svg) {
                const id = current.id;
                if (id && shelfPrefixes.some(prefix => id.startsWith(prefix + '_'))) { return id; }
                current = current.parentElement;
            }
            return null;
        }

        function handleSingleSelectClick(shelfId) {
            appState.selectedShelfId = (appState.selectedShelfId === shelfId) ? null : shelfId;
            appState.searchedShelfId = null; appState.isGamingMode = false;
            redrawMapColors(); updateInfoPanel();
        }

        function handleMultiSelectClick(shelfId) {
            if (appState.multiSelectedShelves.has(shelfId)) { appState.multiSelectedShelves.delete(shelfId); }
            else { appState.multiSelectedShelves.add(shelfId); }
            redrawMapColors(); updateInfoPanel();
        }

        function performSearch() {
            appState.selectedShelfId = null; appState.multiSelectedShelves.clear();
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) { redrawMapColors(); return; }
            if (searchTerm === 'ゲーミング棚' || searchTerm === 'gamingshelf') {
                appState.isGamingMode = true; appState.searchedShelfId = null; log('✨🎉 ゲーミングモード発動！ 🎉✨');
            } else {
                appState.isGamingMode = false;
                const shelfId = productLocationDatabase[searchTerm];
                if (shelfId) {
                    appState.searchedShelfId = shelfId;
                    const displayName = shelfMasterData[shelfId.split('_')[0]].displayName;
                    const shelfNumber = shelfId.split('_')[1];
                    log(`「${searchTerm}」（${displayName} ${shelfNumber}番）をハイライトします。`);
                } else {
                    appState.searchedShelfId = null; log(`「${searchTerm}」は見つかりませんでした。`);
                }
            }
            redrawMapColors(); searchInput.value = '';
        }

        function updateInfoPanel() {
            if (appState.isMultiSelectMode) { updateInfoPanelForMultiSelect(); }
            else if (appState.selectedShelfId) { updateInfoPanelForSingleSelect(appState.selectedShelfId); }
            else { document.getElementById('info-area').innerHTML = `<p>棚をクリックして商品を編集・確認できます。</p>`; }
        }

        function updateInfoPanelForSingleSelect(shelfId) {
            const infoArea = document.getElementById('info-area');
            const parts = shelfId.split('_');
            const prefix = parts[0];
            const shelfNumber = parts[1];
            const displayName = shelfMasterData[prefix] ? shelfMasterData[prefix].displayName : prefix;
            infoArea.innerHTML = `<h3>${displayName} ${shelfNumber}番</h3><div id="status-area"></div><ul id="product-list"></ul><div><input type="text" class="product-input" id="new-product-input" placeholder="りんご、ばなな..."><button class="add-btn" id="add-product-btn">追加</button></div>`;
            document.getElementById('add-product-btn').onclick = () => {
                const input = document.getElementById('new-product-input');
                if (input.value) { addProductsToShelves([shelfId], input.value); input.value = ''; }
            };
            db.collection('shelves').doc(shelfId).onSnapshot(doc => {
                const productList = document.getElementById('product-list');
                const statusArea = document.getElementById('status-area');
                if (!productList || !statusArea) return;
                const shelfData = doc.exists ? doc.data() : {};
                const isCompleted = shelfData.completed === true;
                statusArea.innerHTML = isCompleted ? `<p id="shelf-status">この棚は登録済みです</p><button id="toggle-status-btn">未登録に戻す</button>` : `<p>この棚はまだ未登録です</p><button id="toggle-status-btn">登録済みにする</button>`;
                document.getElementById('toggle-status-btn').onclick = () => toggleShelfStatus(shelfId, !isCompleted);
                productList.innerHTML = '';
                if (shelfData.products && shelfData.products.length > 0) {
                    shelfData.products.forEach(productName => {
                        const li = document.createElement('li');
                        li.textContent = productName;
                        const deleteBtn = document.createElement('span');
                        deleteBtn.textContent = ' ✖'; deleteBtn.className = 'delete-btn';
                        deleteBtn.onclick = () => deleteProduct(shelfId, productName);
                        li.appendChild(deleteBtn); productList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = '（まだ商品はありません）'; productList.appendChild(li);
                }
            });
        }

        function updateInfoPanelForMultiSelect() {
            const infoArea = document.getElementById('info-area');
            const selectedCount = appState.multiSelectedShelves.size;
            let selectedShelvesHtml = '';
            appState.multiSelectedShelves.forEach(shelfId => {
                const parts = shelfId.split('_');
                const displayName = shelfMasterData[parts[0]] ? shelfMasterData[parts[0]].displayName : parts[0];
                selectedShelvesHtml += `<li>${displayName} ${parts[1]}番</li>`;
            });
            infoArea.innerHTML = `<h3>複数選択モード</h3><p>${selectedCount}個の棚を選択中</p><ul>${selectedShelvesHtml}</ul><div><input type="text" class="product-input" id="new-products-input" placeholder="りんご、ばなな..."><button class="add-btn" id="add-products-btn">選択中の棚に追加</button></div>`;
            document.getElementById('add-products-btn').onclick = () => {
                const input = document.getElementById('new-products-input');
                if (input.value) { addProductsToShelves(Array.from(appState.multiSelectedShelves), input.value); input.value = ''; }
            };
        }

        function addProductsToShelves(shelfIds, productsString) {
            const normalizedString = productsString.replace(/、/g, ',');
            const productNames = normalizedString.split(',').map(name => name.trim()).filter(name => name);
            if (productNames.length === 0 || shelfIds.length === 0) return;
            shelfIds.forEach(shelfId => {
                db.collection('shelves').doc(shelfId).set({
                    products: firebase.firestore.FieldValue.arrayUnion(...productNames)
                }, { merge: true });
            });
        }

        function deleteProduct(shelfId, productName) {
            db.collection('shelves').doc(shelfId).update({ products: firebase.firestore.FieldValue.arrayRemove(productName) });
        }
        function toggleShelfStatus(shelfId, newStatus) {
            db.collection('shelves').doc(shelfId).set({ completed: newStatus }, { merge: true });
        }
        async function exportAllDataToCsv() {
            log('全データをエクスポートしています...');
            try {
                const snapshot = await db.collection('shelves').get();
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "商品名,棚ID,棚の正式名称,登録完了\r\n";
                snapshot.forEach(doc => {
                    const shelfId = doc.id;
                    const data = doc.data();
                    const prefix = shelfId.split('_')[0];
                    const displayName = shelfMasterData[prefix] ? shelfMasterData[prefix].displayName : prefix;
                    const isCompleted = data.completed ? 'はい' : 'いいえ';
                    if (data.products && Array.isArray(data.products)) {
                        data.products.forEach(productName => {
                            csvContent += `"${productName}","${shelfId}","${displayName}","${isCompleted}"\r\n`;
                        });
                    }
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "products_backup.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('全データのCSVエクスポートが完了しました。');
            } catch (error) { console.error("CSVエクスポートエラー:", error); log('CSVのエクスポート中にエラーが発生しました。'); }
        }
    </script>
</body>

</html>